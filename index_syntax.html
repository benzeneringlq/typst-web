<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CodeMirror + Typst Syntax Check</title>
  <style>
    html, body { margin: 0; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { display: flex; flex-direction: row; }
    #editor { flex: 1; height: 100%; font-family: monospace; font-size: 14px; padding: 10px; box-sizing: border-box; border-right: 2px solid #ccc; resize: none; }
    #error { width: 50%; padding: 20px; font-family: monospace; white-space: pre-wrap; background: #f5f5f5; overflow: auto; }
  </style>
</head>
<body>
  <textarea id="editor" spellcheck="false"></textarea>
  <div id="error">Loading Typst...</div>

  <!-- Typst all-in-one bundle -->
  <script type="module"
    src="https://cdn.jsdelivr.net/npm/@myriaddreamin/typst.ts/dist/esm/contrib/all-in-one-lite.bundle.js"></script>

  <script type="module">
    const editor = document.getElementById("editor");
    const errorDiv = document.getElementById("error");

    // 初始文档内容
    editor.value = `#set page("us-letter")
#set text(font: "Linux Libertine", size: 11pt)

= Hello Typst!

Type something here and see the live preview below.

== Math Example

$ e^x = sum_(i=0)^infinity x^i / i! $

== Lists

- First item
- Second item
- Third item

== Code

\`\`\`python
def hello():
    print("Hello, World!")
\`\`\`

*Bold text* and _italic text_.`;

    // 初始化 Typst
    $typst.setCompilerInitOptions({
      getModule: () => "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler/pkg/typst_ts_web_compiler_bg.wasm",
    });
    $typst.setRendererInitOptions({
      getModule: () => "https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-renderer/pkg/typst_ts_renderer_bg.wasm",
    });

    let compileTimeout;

    // 仅语法检查函数
    const checkSyntax = async (mainContent) => {
      try {
        await $typst.doPrepareUse(); // 初始化环境
        const compiler = await $typst.getCompilerReset(); // 获取干净的 compiler
        const options = await $typst.getCompileOptions({ mainContent });
        const result = await compiler.compile({ ...options, format: undefined }); // 内部编译
        const diagnostics = result?.diagnostics || [];
        if (diagnostics.length === 0) {
          errorDiv.textContent = "✅ Syntax OK";
        } else {
          errorDiv.textContent = "❌ Syntax Errors:\n" + diagnostics.map(d => d.message).join("\n");
        }
      } catch (err) {
        errorDiv.textContent = "❌ Typst Error:\n" + (err.message || err);
      }
    };

    // 输入变化监听（防抖）
    editor.addEventListener("input", () => {
      clearTimeout(compileTimeout);
      compileTimeout = setTimeout(() => checkSyntax(editor.value), 300);
    });

    // 支持 Tab 缩进
    editor.addEventListener("keydown", (e) => {
      if (e.key === "Tab") {
        e.preventDefault();
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        editor.value = editor.value.substring(0, start) + "  " + editor.value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + 2;
      }
    });

    // 首次检查
    checkSyntax(editor.value);
  </script>
</body>
</html>
